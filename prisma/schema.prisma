// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TriageForm {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Header Section
  reviewer           String
  technologyId       String
  inventorsTitle     String
  domainAssetClass   String

  // Technology Overview
  technologyOverview String

  // Mission Alignment (0-3 score)
  missionAlignmentText  String
  missionAlignmentScore Int    @default(0)

  // Unmet Need (0-3 score)
  unmetNeedText  String
  unmetNeedScore Int    @default(0)

  // State of the Art (0-3 score)
  stateOfArtText  String
  stateOfArtScore Int    @default(0)

  // Market Analysis
  marketOverview String
  marketScore    Int @default(0) // Auto-calculated

  // Digital/Software Considerations (4 yes/no questions)
  digitalQuestion1 Boolean @default(false)
  digitalQuestion2 Boolean @default(false)
  digitalQuestion3 Boolean @default(false)
  digitalQuestion4 Boolean @default(false)

  // Calculated Scores
  impactScore        Float @default(0) // Mission Alignment 50% + Unmet Need 50%
  valueScore         Float @default(0) // State of Art 50% + Market 50%
  recommendation     String @default("") // "Proceed" or "Alternative Pathway"
  recommendationText String @default("")

  // Status
  status String @default("draft") // draft, submitted, reviewed

  // Related tables
  competitors Competitor[]
  experts     SubjectMatterExpert[]

  @@map("triage_forms")
}

model Competitor {
  id                String     @id @default(cuid())
  triageFormId      String
  company           String
  productDescription String
  productRevenue    String?
  pointOfContact    String?

  triageForm TriageForm @relation(fields: [triageFormId], references: [id], onDelete: Cascade)

  @@map("competitors")
}

model SubjectMatterExpert {
  id              String     @id @default(cuid())
  triageFormId    String
  name            String
  title           String?
  organization    String?
  contactInfo     String?
  expertise       String?
  recommendation  String?

  triageForm TriageForm @relation(fields: [triageFormId], references: [id], onDelete: Cascade)

  @@map("subject_matter_experts")
}

// ===== DYNAMIC FORM SYSTEM MODELS =====

model FormTemplate {
  id          String   @id @default(cuid())
  name        String
  version     String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sections    FormSection[]
  submissions FormSubmission[]

  @@map("form_templates")
}

model FormSection {
  id           String   @id @default(cuid())
  templateId   String
  code         String   // e.g., "F0", "F1"
  title        String   // e.g., "Header and identifiers"
  description  String?
  order        Int
  isRequired   Boolean  @default(true)

  template     FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions    FormQuestion[]

  @@map("form_sections")
}

model FormQuestion {
  id             String   @id @default(cuid())
  sectionId      String
  fieldCode      String   // e.g., "F0.1", "F1.2.a"
  label          String
  type           FieldType
  helpText       String?
  placeholder    String?
  validation     Json?    // Validation rules
  conditional    Json?    // Show/hide conditions
  repeatableConfig Json?  // Configuration for repeatable/data table fields
  order          Int
  isRequired     Boolean  @default(false)

  section        FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  options        QuestionOption[]
  scoringConfig  ScoringConfig?

  @@map("form_questions")
}

enum FieldType {
  SHORT_TEXT
  LONG_TEXT
  INTEGER
  SINGLE_SELECT
  MULTI_SELECT
  CHECKBOX_GROUP
  DATE
  REPEATABLE_GROUP
  SCORING_0_3
  SCORING_MATRIX
  DATA_TABLE_SELECTOR
}

model QuestionOption {
  id         String @id @default(cuid())
  questionId String
  value      String
  label      String
  order      Int

  question   FormQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model ScoringConfig {
  id         String @id @default(cuid())
  questionId String @unique
  minScore   Int    @default(0)
  maxScore   Int    @default(3)
  weight     Float  @default(1.0)
  criteria   Json   // Scoring criteria for each value

  question   FormQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("scoring_configs")
}

model FormSubmission {
  id           String   @id @default(cuid())
  templateId   String
  status       SubmissionStatus @default(DRAFT)
  submittedBy  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  submittedAt  DateTime?

  template     FormTemplate @relation(fields: [templateId], references: [id])
  responses    QuestionResponse[]
  repeatGroups RepeatableGroupResponse[]
  scores       CalculatedScore[]

  @@map("form_submissions")
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  ARCHIVED
}

model QuestionResponse {
  id           String @id @default(cuid())
  submissionId String
  questionCode String
  value        Json   // Flexible storage for any response type

  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("question_responses")
}

model RepeatableGroupResponse {
  id           String @id @default(cuid())
  submissionId String
  questionCode String
  rowIndex     Int
  data         Json   // Store row data as JSON

  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("repeatable_group_responses")
}

model CalculatedScore {
  id           String @id @default(cuid())
  submissionId String
  scoreType    String // e.g., "impact", "value", "market"
  value        Float
  calculatedAt DateTime @default(now())

  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("calculated_scores")
}
