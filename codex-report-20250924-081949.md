# Tech Triage Platform â€“ Repository Deep Dive (2025-09-24 08:19:49 UTC)

## Project Snapshot
- Dynamic form workflow at `src/app/dynamic-form/page.tsx` now manages draft and submit journeys against Prisma, while the hardcoded `/form` path stays as the UX baseline.
- Persistence, draft handling, and score writes live inside the server actions at `src/app/dynamic-form/actions.ts`, layered on top of the shared `FormEngineProvider` in `src/lib/form-engine/renderer.tsx`.
- Docker deliverables rely on the multi-stage `Dockerfile`, `docker-compose.yml`, and the orchestration script `scripts/start.sh` to ship a standalone Next 15 build alongside Postgres 15.
- Regression suites under `src/__tests__` (for example `src/__tests__/data-persistence.test.tsx`) still represent historical bug reproductions and no longer mirror the latest Prisma schema or runtime behaviour.

## TypeScript & Build Health
- `npm run build` succeeds, but `npx tsc --noEmit` fails because test fixtures inject Prisma fields (`createdAt`, `updatedAt`, etc.) that no longer exist on the typed interfaces; see `src/__tests__/data-persistence.test.tsx` and `src/__tests__/validation-enforcement.test.tsx`.
- Jest DOM matchers such as `toBeInTheDocument` and `toHaveValue` are flagged as missing (`src/__tests__/validation-enforcement.test.tsx`) because their type definitions are not merged into the TypeScript environment despite the runtime import in `jest.setup.js`.
- JSON persistence in `submitFormResponse`/`saveDraftResponse` still relies on broad `as any` casts (`src/app/dynamic-form/actions.ts`), masking the type mismatch with Prisma's `JsonValue` requirements.
- The toolchain skips strict type checking during Docker builds (`tsconfig.json` keeps `allowJs` and `skipLibCheck`, and `package.json` lacks a `type-check` script), so the issues above only appear when `tsc` is executed manually.

## Security Watchlist
- `src/app/api/form-submissions/route.ts` logs entire submissions and returns full payloads without authentication or request validation, exposing sensitive form data.
- Server actions accept caller-supplied `userId` parameters (`src/app/dynamic-form/actions.ts`), so once authentication exists an attacker could operate on another account's drafts by spoofing IDs.
- Prisma is configured to emit query-level logs in production (`src/lib/prisma.ts`), which can leak PII into logs.
- The Docker startup script issues `prisma db push --accept-data-loss` on each boot (`scripts/start.sh`), risking destructive schema changes in any shared environment.
- `docker-compose.yml` ships Postgres with default credentials and a placeholder `NEXTAUTH_SECRET`; these must be overridden before moving beyond local sandboxes.

## Recommended Next Steps
1. Refactor the test fixtures (or add generators) so they align with the Prisma schema, then run `npx tsc --noEmit` and integrate a `type-check` script into CI/Docker.
2. Extend Jest's type definitions (e.g., via a top-level `global.d.ts`) so DOM matchers compile cleanly, and enforce the check in CI.
3. Replace the `any` casts in `src/app/dynamic-form/actions.ts` with `Prisma.JsonValue`-friendly serialization plus Zod validation around incoming payloads in `src/app/api/form-submissions/route.ts`.
4. Source the authenticated user on the server (NextAuth/session) instead of trusting client-supplied IDs, and limit API payloads to the requesting user.
5. Disable Prisma query logging outside development, swap the container boot sequence to `prisma migrate deploy`, and supply hardened secrets/credentials for Docker-based environments.
6. After the above, re-run `npm run build`, `npm run lint`, and `npm run test` to confirm the pipeline stays green.
