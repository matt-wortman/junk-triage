# Tech Triage Platform — Status (2025-09-25)

## Overview
- Application: Next.js 15 (App Router) + Prisma + PostgreSQL
- Purpose: Dynamic triage form with scoring, draft + submit workflow
- Current focus: Containerization, DB role separation, and Azure deployment

## What Works Today
- Local dev: `npm run dev` with Prisma dev service or local Postgres
- Local Docker: `docker compose up --build` starts Postgres + app
  - DB migrations applied on start (via `scripts/start.sh`)
  - Optional demo seed controllable by `RUN_PRISMA_SEED` / `SEED_DEMO_DATA`
  - Health endpoint: `GET /api/health` returns JSON `{ status: 'healthy' }`
- Data model: Dynamic form entities (templates, sections, questions, options) + submissions and responses
- Prisma Studio: can inspect local container data at `http://localhost:5555` when running `npx prisma studio`

## Containerization & Runtime
- Multi‑stage Dockerfile produces a standalone Next.js runtime and includes Prisma artifacts
- App runs as non‑root `node` user and binds to port `3000`
- Compose file provides:
  - `database` service: `postgres:15-alpine`
  - `app` service: runs migrations + seeds (optional) then `node server.js`
  - Healthcheck probes hitting `/api/health`
- Startup script (`scripts/start.sh`):
  - Waits for DB availability
  - Runs migrations using `PRISMA_MIGRATE_DATABASE_URL` (migrator role)
  - Generates Prisma client
  - Seeds when enabled

## Database & Security
- Roles
  - `triage_migrator`: owns schema, runs Prisma migrations
  - `triage_app`: least‑privilege DML (SELECT/INSERT/UPDATE/DELETE)
- Initialization for local Docker:
  - `scripts/db/init-users.sh` creates roles and grants default privileges
- Connection env vars (examples)
  - `DATABASE_URL=postgresql://triage_app:<pwd>@database:5432/triage_db`
  - `PRISMA_MIGRATE_DATABASE_URL=postgresql://triage_migrator:<pwd>@database:5432/triage_db`

## Secrets Management (Current → Target)
- Current: Plain env values in `.env` for local runs (ignored by Git)
- Target for Azure:
  - Store secrets in ACI/Container Apps secret store or Azure Key Vault
  - Do not persist plaintext secrets in files or portal notes
  - Rotate on go‑live (app, migrator, NEXTAUTH secret)

## Azure Deployment — Current State
- Image pushed to ACR: `innovationventures.azurecr.io/tech-triage-platform:prod`
- Container Instance (ACI): initial single‑container attempt restarted due to bad DB host (Prisma dev sandbox URL)
- Resolution path:
  1) Run as multi‑container group in ACI (app + postgres) with an Azure File Share for `/var/lib/postgresql/data`, OR
  2) Use Azure Database for PostgreSQL flexible server and keep ACI single‑container
- Health & readiness: `/api/health` is the probe endpoint; set `HOSTNAME=0.0.0.0`, `PORT=3000`

## Data Verification
- Confirmed submissions appear in DB (example Tech ID `1011‑1011` recorded twice: draft + submitted)
- Helpful queries:
  - "Tech ID" responses: `SELECT "submissionId", value FROM question_responses WHERE "questionCode"='F0.1';`
  - Full Q/A for a submission (ordered): join `form_questions` on `questionCode` and order by section + order

## Open Actions (Prioritized)
1. Decide DB hosting for Azure
   - A: Managed Postgres (recommended) → set firewall/VNet and update `DATABASE_URL`/`PRISMA_MIGRATE_DATABASE_URL`
   - B: ACI multi‑container (app+db) with Azure File Share for persistence
2. Secrets hardening
   - Move production secrets to Key Vault or ACI secrets; rotate on go‑live
3. Azure HTTPS front end
   - Terminate TLS via Application Gateway/Front Door; point `NEXTAUTH_URL` to public hostname
4. Deployment automation
   - Add build/push GitHub Action for ACR; parametrize environment variables
5. Observability
   - Enable Container Insights/Log Analytics for ACI; add alerts on restarts and healthcheck failures

## Quick Reference
- Local compose: `docker compose up --build`
- Health: `curl http://localhost:3000/api/health`
- Prisma Studio (host): `npx prisma studio` → `http://localhost:5555`
- ACR push:
  - `az acr login --name innovationventures`
  - `docker tag tech-triage-platform-app:latest innovationventures.azurecr.io/tech-triage-platform:prod`
  - `docker push innovationventures.azurecr.io/tech-triage-platform:prod`

## Risks & Notes
- Using Postgres inside ACI without a mounted volume risks data loss on restart; prefer managed DB or Azure File Share
- Prisma dev sandbox URLs (`prisma+postgres://…SandboxHost…`) must not be used in Azure; replace with real hosts
- Seed defaults should be disabled in production (`RUN_PRISMA_SEED=false`, `SEED_DEMO_DATA=false`)

